<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <title>IADMS - Geolocaliza√ß√£o | </title>

  <!-- Bootstrap -->
  <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="../vendors/bootstrap/dist/css/swiper-bundle.min.css" rel="stylesheet">


  <!-- Font Awesome -->
  <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">

  <!-- NProgress -->
  <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
  <!-- bootstrap-progressbar -->
  <link href="../vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
  <!-- PNotify -->
  <link href="../vendors/pnotify/dist/pnotify.css" rel="stylesheet">
  <link href="../vendors/pnotify/dist/pnotify.buttons.css" rel="stylesheet">
  <link href="../vendors/pnotify/dist/pnotify.nonblock.css" rel="stylesheet">
  <!-- Custom Theme Style -->
  <link href="../build/css/custom.min.css" rel="stylesheet">
  <link href="../build/css/style-map.css" rel="stylesheet">
</head>

<body class="nav-md">

  <div id="map"></div>
  <div id="street-view"></div>

  <!-- sidebar menu -->
  <div class="menu">
    <div id="profileContainer" style="padding-top: 80px;"></div>
  </div>

  <!-- top navigation -->
  <div id="topNav"></div>
  <!-- /top navigation -->

  <div id="footer"></div>
  <!-- sidebar menu -->

  <div class="search-container">
    <input type="text" class="search-input" placeholder="Search...">
    <button class="filter-toggle-button">üîç</button>
    <div class="filters-container">
      <div class="filters-header">
        <span>Filters</span>
        <button class="reset-button">reset</button>
      </div>
      <ul class="filters-list">
        <li class="filter-item">
          <input type="checkbox" id="theaters">
          <label for="theaters">
            <span class="filter-icon">üé≠</span>
            <span class="filter-text">Theaters</span>
            <span class="filter-count">2</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="churches">
          <label for="churches">
            <span class="filter-icon">‚õ™</span>
            <span class="filter-text">Churches</span>
            <span class="filter-count">2</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="automotive">
          <label for="automotive">
            <span class="filter-icon">üöó</span>
            <span class="filter-text">Automotive</span>
            <span class="filter-count">1</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="squares">
          <label for="squares">
            <span class="filter-icon">‚¨õ</span>
            <span class="filter-text">Squares</span>
            <span class="filter-count">2</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="virtual-tour">
          <label for="virtual-tour">
            <span class="filter-icon">üåê</span>
            <span class="filter-text">Virtual Tour</span>
            <span class="filter-count">2</span>
          </label>
        </li>
      </ul>
    </div>
  </div>
  <!-- Menu flutuante -->
  <div class="menu-button">
    <button id="satellite-home" aria-label="Home View"><i class="fa fa-home"></i></button>
    <button id="satellite-globe" aria-label="globe View"><i class="fa fa-globe"></i></button>
    <button id="route" aria-label="route View"><i class="fa fa-exchange"></i></button>
    <button id="bookmark" aria-label="bookmark View"><i class="fa fa-bookmark"></i></button>
  </div>

  <div class="swiper-container">
    <div class="swiper-wrapper" id="churchSwiperItems">
    </div>
    <div class="swiper-button-next">
      <i class="fa fa-chevron-right"></i>
    </div>
    <div class="swiper-button-prev">
      <i class="fa fa-chevron-left"></i>
    </div>
    <div class="swiper-pagination"></div>
  </div>

  <!-- jQuery -->
  <script src="../vendors/jquery/dist/jquery.min.js"></script>
  <script src="../vendors/jquery/dist/swiper-bundle.min.js"></script>

  <!-- Bootstrap -->
  <script src="../vendors/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FastClick -->
  <script src="../vendors/fastclick/lib/fastclick.js"></script>
  <!-- NProgress -->
  <script src="../vendors/nprogress/nprogress.js"></script>
  <!-- Chart.js -->
  <script src="../vendors/Chart.js/dist/Chart.min.js"></script>
  <!-- jQuery Sparklines -->
  <script src="../vendors/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
  <!-- easy-pie-chart -->
  <script src="../vendors/jquery.easy-pie-chart/dist/jquery.easypiechart.min.js"></script>
  <!-- bootstrap-progressbar -->
  <script src="../vendors/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>

  <!-- PNotify -->
  <script src="../vendors/pnotify/dist/pnotify.js"></script>
  <script src="../vendors/pnotify/dist/pnotify.buttons.js"></script>
  <script src="../vendors/pnotify/dist/pnotify.nonblock.js"></script>
  <!-- Custom Theme Scripts -->
  <script src="../build/js/custom.min.js"></script>
  <script src="../build/js/load-components.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Scripts Customizados -->
  <script src="../build/js/notifier.js"></script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh3uUlNUV1D7IjRwKV3QgLh_89cAXfy-E&callback=initMap&libraries=marker&loading=async"></script>

  <script>
    document.querySelectorAll('.slider-item').forEach((item, index) => {
      /* item.addEventListener('click', () => {
        const marker = markers[index]; // Assumindo que os marcadores est√£o em um array na mesma ordem dos itens
        map.setCenter(marker.getPosition());
        google.maps.event.trigger(marker, 'click'); // Simula o clique no marcador
      }); */
      item.addEventListener('click', () => {
        const marker = markers[index]; // Assumindo que os marcadores est√£o em um array na mesma ordem dos itens
        if (marker) {
          map.setCenter(marker.getPosition()); // Centraliza o mapa na posi√ß√£o do marcador
          map.setZoom(15); // Ajusta o n√≠vel de zoom (opcional)
        }
      });
    });
    const slider = document.querySelector('.slider');
    const sliderContainer = document.querySelector('.slider-container');

    let map;
    let panorama;
    const markers = [];

    function initMap() {
      const token = localStorage.getItem('authToken');

      if (!token) {
        console.error("Token n√£o encontrado. Redirecionando para login...");
        window.location.href = "/login";
      }

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 8,
        mapTypeControl: true, // Habilita controle de tipo de mapa (sat√©lite, terreno, etc.)
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.DROPDOWN_MENU, // Estilo do controle
          position: google.maps.ControlPosition.TOP_RIGHT, // Posi√ß√£o no mapa
        },
        zoomControl: true, // Habilita o controle de zoom
        zoomControlOptions: {
          position: google.maps.ControlPosition.RIGHT_BOTTOM, // Posi√ß√£o no mapa
        },
        fullscreenControl: true, // Habilita o controle de tela cheia
        fullscreenControlOptions: {
          position: google.maps.ControlPosition.RIGHT_BOTTOM, // Posi√ß√£o no mapa
        },
        streetViewControl: true, // Habilita o controle de Street View
        streetViewControlOptions: {
          position: google.maps.ControlPosition.RIGHT_BOTTOM, // Posi√ß√£o no mapa
        },
      });

      // Inicializa o panorama (Street View)
      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("street-view"),
        {
          position: { lat: -34.397, lng: 150.644 },
          pov: { heading: 275, pitch: 0 }, // Define a dire√ß√£o da c√¢mera
          enableCloseButton: true, // Exibe o bot√£o nativo de fechar/voltar
        }
      );

      map.setStreetView(panorama); // Define o mapa para usar o Street View

      loadLocations();
    }

    function loadLocations() {
      const token = localStorage.getItem('authToken');

      fetch('http://localhost:3000/api/churches', {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(response => response.json())
        .then(data => {
          const locations = Array.isArray(data) ? data : data.locations || [];
          const bounds = new google.maps.LatLngBounds();
          const swiperWrapper = document.getElementById('churchSwiperItems');
          swiperWrapper.innerHTML = '';

          locations.forEach((location, index) => {
            if (location.localizacao?.latitude && location.localizacao?.longitude) {
              const { latitude, longitude } = location.localizacao;

              const marker = new google.maps.Marker({
                position: { lat: latitude, lng: longitude },
                map,
                title: location.nome,
              });


              const infowindow = new google.maps.InfoWindow({
                content: `<b>${location.nome}</b><br>${location.endereco.logradouro}, ${location.endereco.numero}`,
              });

              marker.addListener("click", function () {
                infowindow.open(map, marker);
                panorama.setPosition(marker.getPosition());
                document.getElementById("street-view").style.display = "block";
              });

              markers.push(marker);
              bounds.extend(marker.getPosition());

              const slide = document.createElement('div');
              slide.classList.add('swiper-slide');
              slide.innerHTML = `
                <div class="row">
                  <div class="col-md-5">
                    <img src="https://via.placeholder.com/100/ff0000/ffffff" class="swiper-img-top" alt="Igreja">
                  </div>                  
                  <div class="col-md-7">
                    <div class="swiper-media-body">
                      <p class="title">${location.nome}
                      <br>${location.endereco.logradouro}, ${location.endereco.numero}</p>
                    </div>
                  </div>
                </div>`;

              slide.addEventListener('click', () => {
                map.setCenter(marker.getPosition());
                map.setZoom(15);
              });

              swiperWrapper.appendChild(slide);
            }
          });

          map.fitBounds(bounds);

          new Swiper('.swiper-container', {
            navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
            pagination: { el: '.swiper-pagination', clickable: true },
            slidesPerView: 3,
            spaceBetween: 8,
          });
        })
        .catch(err => console.error('Erro ao carregar locais:', err));
    }
  </script>
</body>

</html>