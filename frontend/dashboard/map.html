<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <title>IADMS - Geolocaliza√ß√£o | </title>

  <!-- Bootstrap -->
  <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <!-- NProgress -->
  <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
  <!-- bootstrap-progressbar -->
  <link href="../vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
  <!-- PNotify -->
  <link href="../vendors/pnotify/dist/pnotify.css" rel="stylesheet">
  <link href="../vendors/pnotify/dist/pnotify.buttons.css" rel="stylesheet">
  <link href="../vendors/pnotify/dist/pnotify.nonblock.css" rel="stylesheet">
  <!-- Custom Theme Style -->
  <link href="../build/css/custom.min.css" rel="stylesheet">
  <link href="../build/css/style-map.css" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh3uUlNUV1D7IjRwKV3QgLh_89cAXfy-E&callback=initMap" async defer></script> -->
  <style>
    #street-view {
      width: 100%;
      height: 400px;
    }
  </style>

</head>

<body class="nav-md">

  <div id="map"></div>
  <div id="street-view" style="width: 100%; height: 400px;"></div>


  <!-- sidebar menu -->
  <div class="menu">
    <!-- menu profile quick info -->
    <div id="profileContainer"></div>
  </div>

  <!-- top navigation -->
  <div id="topNav"></div>
  <!-- /top navigation -->

  <div id="footer"></div>
  <!-- sidebar menu -->
  <div class="menu2">
  </div>

  <div class="search-container">
    <input type="text" class="search-input" placeholder="Search...">
    <button class="filter-toggle-button">üîç</button>
    <div class="filters-container">
      <div class="filters-header">
        <span>Filters</span>
        <button class="reset-button">reset</button>
      </div>
      <ul class="filters-list">
        <li class="filter-item">
          <input type="checkbox" id="theaters">
          <label for="theaters">
            <span class="filter-icon">üé≠</span>
            <span class="filter-text">Theaters</span>
            <span class="filter-count">2</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="churches">
          <label for="churches">
            <span class="filter-icon">‚õ™</span>
            <span class="filter-text">Churches</span>
            <span class="filter-count">2</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="automotive">
          <label for="automotive">
            <span class="filter-icon">üöó</span>
            <span class="filter-text">Automotive</span>
            <span class="filter-count">1</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="squares">
          <label for="squares">
            <span class="filter-icon">‚¨õ</span>
            <span class="filter-text">Squares</span>
            <span class="filter-count">2</span>
          </label>
        </li>
        <li class="filter-item">
          <input type="checkbox" id="virtual-tour">
          <label for="virtual-tour">
            <span class="filter-icon">üåê</span>
            <span class="filter-text">Virtual Tour</span>
            <span class="filter-count">2</span>
          </label>
        </li>
      </ul>
    </div>
  </div>


  <div class="menu-container">
    <div class="menu-item">
      <div class="row">
        <div class="col-md-4">
          <img src="images/media.jpg" alt="Ferrari" class="menu-image">
        </div>
        <div class="col-md-8">
          <div class="menu-text">
            <h2>Ferrari Maranello</h2>
            <p>Via Abetone Inferiore 19, Maranello, 41053, Italy</p>
          </div>
        </div>
      </div>
    </div>
    <div class="menu-item">
      <div class="row">
        <div class="col-md-4">
          <img src="images/media.jpg" alt="Ferrari" class="menu-image">
        </div>
        <div class="col-md-8">
          <div class="menu-text">
            <h2>Ferrari Maranello</h2>
            <p>Via Abetone Inferiore 19, Maranello, 41053, Italy</p>
          </div>
        </div>
      </div>
    </div>
    <div class="menu-item">
      <div class="row">
        <div class="col-md-4">
          <img src="images/media.jpg" alt="Ferrari" class="menu-image">
        </div>
        <div class="col-md-8">
          <div class="menu-text">
            <h2>Ferrari Maranello</h2>
            <p>Via Abetone Inferiore 19, Maranello, 41053, Italy</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Menu flutuante -->
  <div class="menu-button">
    <button id="satellite"><i class="fa fa-globe"></i></button>
    <button id="route"><i class="fa fa-exchange"></i></button>
    <button id="bookmark"><i class="fa fa-bookmark"></i></button>
  </div>

  <!-- Menu flutuante -->
  <div class="menu-button-right">
    <button class="btn btn-round btn-info" id="satellite"><i class="fa fa-home"></i></button>
    <button id="route"><i class="fa fa-plus"></i></button>
    <button id="route"><i class="fa fa-minus"></i></button>
    <button id="bookmark"><i class="fa fa-expand"></i></button>
  </div>

  <!-- jQuery -->
  <script src="../vendors/jquery/dist/jquery.min.js"></script>
  <!-- Bootstrap -->
  <script src="../vendors/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <!-- FastClick -->
  <script src="../vendors/fastclick/lib/fastclick.js"></script>
  <!-- NProgress -->
  <script src="../vendors/nprogress/nprogress.js"></script>
  <!-- Chart.js -->
  <script src="../vendors/Chart.js/dist/Chart.min.js"></script>
  <!-- jQuery Sparklines -->
  <script src="../vendors/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
  <!-- easy-pie-chart -->
  <script src="../vendors/jquery.easy-pie-chart/dist/jquery.easypiechart.min.js"></script>
  <!-- bootstrap-progressbar -->
  <script src="../vendors/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>

  <!-- PNotify -->
  <script src="../vendors/pnotify/dist/pnotify.js"></script>
  <script src="../vendors/pnotify/dist/pnotify.buttons.js"></script>
  <script src="../vendors/pnotify/dist/pnotify.nonblock.js"></script>
  <!-- Custom Theme Scripts -->
  <script src="../build/js/custom.min.js"></script>
  <script src="../build/js/load-components.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Scripts Customizados -->
  <script src="../build/js/notifier.js"></script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh3uUlNUV1D7IjRwKV3QgLh_89cAXfy-E&callback=initMap&libraries=marker&loading=async"></script>

  <script>
    let map;
    let panorama; // Para o Street View
    const markers = []; // Array para armazenar os marcadores

    function initMap() {
      // Inicializa o mapa
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 8,
      });

      // Inicializa o panorama (Street View)
      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("street-view"), {
        position: { lat: -34.397, lng: 150.644 },
        pov: { heading: 165, pitch: 0 }, // Defina a dire√ß√£o da c√¢mera
      }
      );
      map.setStreetView(panorama); // Define o mapa para usar o Street View

      // Carregar as localiza√ß√µes atrav√©s da API
      loadLocations();
    }

    function loadLocations() {
      const token = localStorage.getItem('authToken');

      $.ajax({
        url: 'http://localhost:3000/api/churches',
        method: 'GET',
        headers: {
          Authorization: `Bearer ${token}`,
        },
        success: function (data) {
          console.log('Dados recebidos:', data);

          // Remove todos os marcadores existentes
          markers.forEach(marker => marker.setMap(null));
          markers.length = 0; // Limpa o array de marcadores

          const bounds = new google.maps.LatLngBounds();

          data.forEach(location => {
            if (location.localizacao && location.localizacao.latitude && location.localizacao.longitude) {
              const { latitude, longitude } = location.localizacao;

              console.warn(`Dados de localiza√ß√£o: ${location.nome}`, location);

              const marker = new google.maps.Marker({
                position: { lat: latitude, lng: longitude },
                map: map,
                title: location.nome,
              });

              const infowindow = new google.maps.InfoWindow({
                content: `<b>${location.nome}</b><br>${location.endereco.logradouro}, ${location.endereco.numero}`,
              });

              marker.addListener("click", function () {
                infowindow.open(map, marker);

                // Atualiza o panorama (Street View) para a localiza√ß√£o do marcador
                panorama.setPosition(marker.getPosition());
              });

              // Adiciona o marcador ao array
              markers.push(marker);

              // Expande o limite do mapa para incluir este marcador
              bounds.extend(marker.getPosition());
            } else {
              console.warn(`Dados de localiza√ß√£o incompletos para: ${location.nome}`, location);
            }
          });

          // Ajusta o mapa para mostrar todos os marcadores
          if (markers.length > 0) {
            map.fitBounds(bounds);
          } else {
            console.warn('Nenhuma localiza√ß√£o v√°lida encontrada.');
          }
        },
        error: function (jqXHR) {
          const errorData = JSON.parse(jqXHR.responseText);
          const errorMessage = errorData.message || 'Erro desconhecido';
          console.error('Erro ao carregar os dados!:', jqXHR.responseText);
          alert('Erro: ' + errorMessage);
        },
      });
    }
    /*  $(document).ready(function () {
 
       const token = localStorage.getItem('authToken');
 
       if (!token) {
         console.error("Token n√£o encontrado. Redirecionando para login...");
         window.location.href = "/login"; // Redireciona para login se o token n√£o existir
       } else {
         console.log("Token carregado:", token);
       }
 
       const map = L.map('map').setView([-23.55052, -46.633308], 13); // Inicializa o mapa
       console.log('Mapa inicializado:', map);
 
       L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
         maxZoom: 19,
       }).addTo(map);
 
       const loadLocations = () => {
         if (!token) {
           Notifier.notifyError('Token n√£o encontrado', 'Por favor, fa√ßa o login para continuar.');
           return;
         }
 
         $.ajax({
           url: 'http://localhost:3000/api/churches',
           method: 'GET',
           headers: {
             Authorization: `Bearer ${token}`,
           },
           success: function (data) {
             console.log('Dados recebidos:', data);
 
             // Remove todos os marcadores existentes do mapa
             map.eachLayer((layer) => {
               if (layer instanceof L.Marker) map.removeLayer(layer);
             });
 
             const bounds = []; // Array para armazenar todas as coordenadas
 
             data.forEach((location) => {
               if (location.localizacao && location.localizacao.latitude && location.localizacao.longitude) {
                 const { latitude, longitude } = location.localizacao;
 
                 console.warn(`Dados de localiza√ß√£o: ${location.nome}`, location);
 
                 const marker = L.marker([latitude, longitude]).addTo(map);
                 marker.bindPopup(`<b>${location.nome}</b><br>${location.endereco.logradouro}, ${location.endereco.numero}`);
 
                 // Adiciona as coordenadas ao array de bounds
                 bounds.push([latitude, longitude]);
               } else {
                 console.warn(`Dados de localiza√ß√£o incompletos para: ${location.nome}`, location);
               }
             });
 
             // Ajusta o mapa para mostrar todos os marcadores
             if (bounds.length > 0) {
               map.fitBounds(bounds);
             } else {
               console.warn('Nenhuma localiza√ß√£o v√°lida encontrada.');
             }
           },
           error: function (jqXHR) {
             const errorData = JSON.parse(jqXHR.responseText);
             const errorMessage = errorData.message || 'Erro desconhecido';
             console.error('Erro ao carregar os dados!:', jqXHR.responseText);
             Notifier.notifyError('Erro', errorMessage);
           },
         });
       };
 
       loadLocations(); // Carrega as localiza√ß√µes ao iniciar;
 
 
       const editLocation = (id) => {
         const token = localStorage.getItem('authToken');
         const updatedData = {
           nome: prompt('Digite o novo nome:'),
           status: prompt('Digite o novo status:'),
           latitude: prompt('Digite a nova latitude:'),
           longitude: prompt('Digite a nova longitude:'),
         };
 
         $.ajax({
           url: `http://localhost:3000/api/churches/${id}`,
           method: 'PUT',
           headers: {
             Authorization: `Bearer ${token}`,
           },
           contentType: 'application/json',
           data: JSON.stringify(updatedData),
           success: function () {
             Notifier.notifySuccess('Sucesso!', 'Localiza√ß√£o atualizada com sucesso!');
             loadLocations();
           },
           error: function (jqXHR) {
             console.error('Erro ao atualizar a localiza√ß√£o:', jqXHR.responseText);
             Notifier.notifyError('Erro ao atualizar a localiza√ß√£o!!', jqXHR.responseText);
           },
         });
       };
 
       document.querySelector('.filter-toggle-button').addEventListener('click', () => {
         const filtersContainer = document.querySelector('.filters-container');
         filtersContainer.classList.toggle('show');
       });
 
       document.querySelector('.reset-button').addEventListener('click', () => {
         document.querySelectorAll('.filters-list input[type="checkbox"]').forEach((checkbox) => {
           checkbox.checked = false;
         });
       });
     }); */
  </script>
</body>

</html>