<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>IADMS - Geolocalização | </title>

  <!-- Bootstrap -->
  <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <!-- NProgress -->
  <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">

  <!-- Custom Theme Style -->
  <link href="../build/css/custom.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    #map {
      height: 400px;
    }

    .leaflet-container {
      height: 400px;
      width: 100%;
      max-width: 100%;
      max-height: 100%;
      border: 1px solid #a0a0a0;
    }

    .buttons {
      margin-top: 10px;
    }

    .buttons button {
      margin-right: 10px;
    }
  </style>
</head>

<body class="nav-md">
  <div class="container body">
    <div class="main_container">
      <div class="col-md-3 left_col">
        <div class="left_col scroll-view">

          <div class="clearfix"></div>
          <!-- menu profile quick info -->
          <div id="profileContainer"></div>
          <!-- /menu profile quick info -->

          <br />

          <!-- sidebar menu -->
          <div id="sidebarMenu"></div>
          <!-- /sidebar menu -->

          <!-- /menu footer buttons -->
          <div class="sidebar-footer hidden-small">
            <a data-toggle="tooltip" data-placement="top" title="Settings">
              <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="FullScreen">
              <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Lock">
              <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Logout" href="login.html">
              <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
            </a>
          </div>
          <!-- /menu footer buttons -->
        </div>
      </div>

      <!-- top navigation -->
      <div id="topNav"></div>
      <!-- /top navigation -->

      <!-- page content -->
      <div class="right_col" role="main">
        <div class="">
          <div class="page-title">
            <div class="title_left">
              <h3>Adicionar igreja</h3>
            </div>
            <div class="title_right">
              <div class="col-md-5 col-sm-5  form-group row pull-right top_search">
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="Buscar por igreja...">
                  <span class="input-group-btn">
                    <button class="btn btn-secondary" type="button">Buscar</button>
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div class="clearfix"></div>
          <div class="row">
            <div class="col-md-12 col-sm-12 ">
              <div class="x_panel">
                <div class="x_title">
                  <h2>Adicionar igreja <small>localização</small></h2>
                  <ul class="nav navbar-right panel_toolbox">
                    <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                    </li>
                    <li class="dropdown">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i
                          class="fa fa-wrench"></i></a>
                      <ul class="dropdown-menu" role="menu">
                        <li><a href="#">Settings 1</a>
                        </li>
                        <li><a href="#">Settings 2</a>
                        </li>
                      </ul>
                    </li>
                    <li><a class="close-link"><i class="fa fa-close"></i></a>
                    </li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <!-- Smart Wizard -->
                  <form class="form-horizontal form-label-left">
                    <p>Utilize o assistente abaixo para preencher os detalhes da igreja em etapas organizadas. Cada
                      seção foi projetada para simplificar o processo de entrada de dados.</p>
                    <div id="wizard" class="form_wizard wizard_horizontal">
                      <ul class="wizard_steps">
                        <li>
                          <a href="#step-1">
                            <span class="step_no">1</span>
                            <span class="step_descr">Etapa 1<br />
                              <small>Nome, igreja e localização</small></span>
                          </a>
                        </li>
                        <li>
                          <a href="#step-2">
                            <span class="step_no">2</span>
                            <span class="step_descr">Etapa 2<br />
                              <small>Detalhes, Contas e Status</small></span>
                          </a>
                        </li>
                        <li>
                          <a href="#step-3">
                            <span class="step_no">3</span>
                            <span class="step_descr">Etapa 3<br />
                              <small>Horário de funcionamento</small></span>
                          </a>
                        </li>
                        <li>
                          <a href="#step-4">
                            <span class="step_no">4</span>
                            <span class="step_descr">Etapa 4<br />
                              <small>Contato e redes sociais</small></span>
                          </a>
                        </li>
                      </ul>
                      <div id="step-1">
                        <h3>Igreja</h3>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Nome da Igreja</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="nome" placeholder="Nome da Igreja" required
                              data-parsley-required-message="O campo Nome da Igreja é obrigatório."
                              data-parsley-trigger="change">
                          </div>

                          <label class="col-sm-3 col-form-label label-align">Categoria</label>
                          <div class="col-sm-3">
                            <select class="form-control" id="categoria" required
                              data-parsley-required-message="O campo Categoria é obrigatório."
                              data-parsley-trigger="change">
                              <option value="">Selecione uma categoria</option>
                              <option value="igreja">Igreja</option>
                              <option value="congregacao">Congregação</option>
                              <option value="sede">Sede</option>
                              <option value="outro">Outro</option>
                            </select>
                          </div>
                        </div>
                        <h3>Endereço</h3>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Logradouro</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="logradouro" placeholder="Logradouro" required
                              data-parsley-required-message="O campo Logradouro é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">Número</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="numero" placeholder="Número"
                              data-parsley-type="digits"
                              data-parsley-type-message="O campo Número deve conter apenas dígitos."
                              data-parsley-trigger="change">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Bairro</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="bairro" placeholder="Bairro" required
                              data-parsley-required-message="O campo Bairro é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">Cidade</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="cidade" placeholder="Cidade" required
                              data-parsley-required-message="O campo Cidade é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Estado</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="estado" placeholder="Estado" required
                              data-parsley-required-message="O campo Estado é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">CEP</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="cep" placeholder="CEP" required
                              data-inputmask="'mask': '99999-999'"
                              data-parsley-pattern-message="O CEP deve estar no formato 12345-678."
                              data-parsley-trigger="change">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Complemento</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="complemento" placeholder="Complemento"
                              data-parsley-trigger="change">
                          </div>
                        </div>
                        <h3>Localização</h3>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Latitude</label>
                          <div class="col-sm-3">
                            <input type="number" step="any" class="form-control" id="latitude" placeholder="Latitude"
                              required data-parsley-type="number" data-parsley-trigger="change"
                              data-parsley-required-message="O campo Latitude é obrigatório."
                              data-parsley-type-message="O campo Latitude deve ser numérico.">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">Longitude</label>
                          <div class="col-sm-3">
                            <input type="number" step="any" class="form-control" id="longitude" placeholder="Longitude"
                              required data-parsley-type="number" data-parsley-trigger="change"
                              data-parsley-required-message="O campo Longitude é obrigatório."
                              data-parsley-type-message="O campo Longitude deve ser numérico.">
                          </div>
                        </div>
                        <div class="form-group row">
                          <div class="col-md-3 col-sm-3">
                            <div class="btn-group-sm buttons">
                              <!--<button type="button" class="btn btn-primary" id="addressPosition">
                                <i class="fa fa-map-marker"></i> Address → Position
                              </button>-->
                              <button type="button" class="btn btn-primary" id="setPosition">
                                <i class="fa fa-map-marker"></i> Setar Posição
                              </button>
                              <button type="button" class="btn btn-primary" id="getGPSPosition">
                                <i class="fa fa-map-marker"></i> Pegar posição pelo GPS
                              </button>
                            </div>
                          </div>
                          <div id="map"></div>
                        </div>
                      </div>

                      <div id="step-2">
                        <h3>Detalhes</h3>
                        <!-- Tipo do Local e Categoria -->
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Tipo do Local</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="tipo_local" placeholder="Tipo do Local" required
                              data-parsley-required-message="O campo Tipo do Local é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">Ponto de Referência</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="ponto_referencia"
                              placeholder="Ponto de referência" required
                              data-parsley-required-message="O campo Ponto de referência é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                        </div>

                        <div class="ln_solid"></div>
                        <div class="form-group row">
                          <label class="col-sm-3 col-md-3 col-form-label label-align">Conta</label>
                          <div class="col-sm-3">
                            <button type="button" id="add-field-btn" class="col-sm-12 btn btn-info btn-sm">
                              <i class="fa fa-plus"></i> Adicione campo para conta
                            </button>
                          </div>

                          <label class="col-sm-3 col-form-label label-align">Status da igreja</label>
                          <div class="col-sm-3">
                            <div id="status" class="btn-group btn-group-sm w-100" data-toggle="buttons">
                              <label class="btn btn-info w-50">
                                <input type="radio" name="status" value="aberta" class="join-btn"> Aberta
                              </label>
                              <label class="btn btn-secondary active w-50">
                                <input type="radio" name="status" value="fechada" class="join-btn"> Fechada
                              </label>
                            </div>
                          </div>
                        </div>

                        <div class="form-group">
                          <!-- Container para os campos dinâmicos -->
                          <div id="dynamic-fields">
                            <!-- Espaço para os campos dinâmicos -->
                          </div>
                        </div>
                        <div class="ln_solid"></div>

                        <!-- Ponto de Referência e Status -->
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Quant. de membros</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="estacionamento"
                              placeholder="Quantidade de membros"
                              data-parsley-required-message="O campo Quantidade de membros é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">Tem estacionamento?</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="estacionamento"
                              placeholder="Tem estacionamento?"
                              data-parsley-required-message="O campo Tem estacionamento? é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                        </div>

                        <!-- Descrição -->
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Descrição</label>
                          <div class="col-sm-9">
                            <textarea class="form-control" id="descricao" required rows="6" placeholder="Descrição"
                              data-parsley-minlength="20" data-parsley-required-message="A descrição é obrigatória!"
                              data-parsley-minlength-message="A descrição deve ter pelo menos 20 caracteres."
                              data-parsley-trigger="keyup"></textarea>
                          </div>
                        </div>
                      </div>

                      <div id="step-3">
                        <!-- Horário de Funcionamento -->
                        <h3>Horário</h3>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Horário de Funcionamento</label>
                          <div class="col-sm-9">
                            <div class="row align-items-center">
                              <div class="col-sm-4">
                                <select class="form-control" id="dias_semana">
                                  <option value="" disabled selected>Selecione um dia</option>
                                  <option value="Segunda-feira">Segunda-feira</option>
                                  <option value="Terça-feira">Terça-feira</option>
                                  <option value="Quarta-feira">Quarta-feira</option>
                                  <option value="Quinta-feira">Quinta-feira</option>
                                  <option value="Sexta-feira">Sexta-feira</option>
                                  <option value="Sábado">Sábado</option>
                                  <option value="Domingo">Domingo</option>
                                </select>
                              </div>
                              <div class="col-sm-3">
                                <input type="time" class="form-control" id="hora_abertura"
                                  placeholder="Hora de Abertura">
                              </div>
                              <div class="col-sm-3">
                                <input type="time" class="form-control" id="hora_fechamento"
                                  placeholder="Hora de Fechamento">
                              </div>
                              <div class="col-sm-2">
                                <button type="button" class="btn btn-primary w-100" id="add_horario">
                                  <i class="fa fa-plus"></i> Adicionar
                                </button>
                              </div>
                            </div>
                            <table class="table table-striped  bulk_action mt-3" id="tabela_horarios">
                              <thead>
                                <tr>
                                  <th>Dia</th>
                                  <th>Hora de Abertura</th>
                                  <th>Hora de Fechamento</th>
                                  <th>Ações</th>
                                </tr>
                              </thead>
                              <tbody>
                                <!-- Linhas serão adicionadas dinamicamente aqui -->
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>

                      <div id="step-4">
                        <h3>Contato</h3>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Telefone</label>
                          <div class="col-sm-3">
                            <input type="text" class="form-control" id="telefone" required placeholder="Telefone"
                              data-inputmask="'mask' : '(99) 99999-9999'"
                              data-parsley-pattern-message="O telefone deve ter entre 10 e 11 dígitos numéricos."
                              data-parsley-trigger="change">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">Email</label>
                          <div class="col-sm-3">
                            <input type="email" class="form-control" id="email" required placeholder="Email"
                              data-parsley-required-message="O campo Email é obrigatório."
                              data-parsley-trigger="change">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Alkipage</label>
                          <div class="col-sm-3">
                            <input type="url" class="form-control" id="alkipage" placeholder="Alkipage" required
                              data-parsley-trigger="change">
                          </div>
                          <label class="col-sm-3 col-form-label label-align">Facebook</label>
                          <div class="col-sm-3">
                            <input type="url" class="form-control" id="facebook" placeholder="Facebook" required
                              data-parsley-trigger="change">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-sm-3 col-form-label label-align">Instagram</label>
                          <div class="col-sm-3">
                            <input type="url" class="form-control" id="instagram" placeholder="Instagram" required
                              data-parsley-trigger="change">
                          </div>
                        </div>
                        <div class="actionBar">
                          <button id="submitButton" class="btn btn-success btn-sm" type="submit">Enviar</button>
                        </div>
                      </div>
                    </div>
                </div>
                </form>
                <!-- End SmartWizard Content -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /page content -->
    <!-- footer content -->
    <div id="footer"></div>
    <!-- /footer content -->
  </div>
  </div>
  <!-- jQuery -->
  <script src="../vendors/jquery/dist/jquery.min.js"></script>
  <!-- Bootstrap -->
  <script src="../vendors/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <!-- FastClick -->
  <script src="../vendors/fastclick/lib/fastclick.js"></script>
  <!-- NProgress -->
  <script src="../vendors/nprogress/nprogress.js"></script>
  <!-- jQuery Smart Wizard -->
  <script src="../vendors/jQuery-Smart-Wizard/js/jquery.smartWizard.js"></script>
  <!-- Custom Theme Scripts -->
  <script src="../build/js/custom.min.js"></script>
  <!-- Parsley -->
  <script src="../vendors/parsleyjs/dist/parsley.min.js"></script>
  <!-- Scripts Customizados -->
  <script src="../build/js/load-components.js"></script>
  <!-- jquery.inputmask -->
  <script src="../vendors/jquery.inputmask/dist/min/jquery.inputmask.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    $(document).ready(function () {

      // Inicializando Parsley.js no formulário
      const $form = $('form');

      $form.parsley();

      // Interceptando o envio do formulário
      $form.on('submit', function (e) {
        e.preventDefault(); // Previne o envio padrão

        // Verifica se o formulário é válido usando Parsley
        if ($form.parsley().isValid()) {
          // Se válido, chama a função de envio do formulário
          console.log('Formulário válido! Dados serão enviados.');
          submitForm(); // Chama a função de envio (exemplo no seu script)
        } else {
          // Caso inválido, exibe mensagens de erro automáticas do Parsley
          console.log("Formulário inválido! Verifique os campos.");
        }
      });

      function isTokenExpired(token) {
        const payload = JSON.parse(atob(token.split('.')[1])); // Decodificar o payload do JWT
        const now = Math.floor(Date.now() / 1000); // Timestamp atual em segundos
        return payload.exp < now;
      }

      const token = localStorage.getItem('authToken');
      if (!token || isTokenExpired(token)) {
        alert('Sua sessão expirou. Faça login novamente.');
        localStorage.removeItem('authToken');
        window.location.href = '/login';
      }

      // Redireciona para login se não houver token
      if (!token) {
        //alert('Você precisa fazer login primeiro.');
        window.location.href = '/login';
        // Use o token para chamadas à API ou outros usos
      }


      // Evento para adicionar horários
      $('#add_horario').on('click', function () {
        const dia = $('#dias_semana').val();
        const horaAbertura = $('#hora_abertura').val();
        const horaFechamento = $('#hora_fechamento').val();

        if (!dia || !horaAbertura || !horaFechamento) {
          alert('Por favor, preencha todos os campos antes de adicionar.');
          return;
        }

        // Adiciona linha à tabela
        const linha = `
        <tr>
          <td>${dia}</td>
          <td>${horaAbertura}</td>
          <td>${horaFechamento}</td>
          <td>
            <button type="button" class="btn btn-danger btn-sm remove-linha">
              <i class="fa fa-trash"></i> Remover
            </button>
          </td>
        </tr>`;
        $('#tabela_horarios tbody').append(linha);

        // Limpa os campos
        $('#dias_semana').val('');
        $('#hora_abertura').val('');
        $('#hora_fechamento').val('');

        // Evento para remover a linha
        $('.remove-linha').on('click', function () {
          $(this).closest('tr').remove();
        });

        console.log('Horário adicionado com sucesso.');
      });


      const buttons = document.querySelectorAll("#status .btn");

      buttons.forEach((button) => {
        button.addEventListener("click", function () {
          buttons.forEach((btn) => {
            btn.classList.remove("btn-info", "active");
            btn.classList.add("btn-secondary");
          });

          this.classList.remove("btn-secondary");
          this.classList.add("btn-info", "active");
        });
      });

      $('#btn-logout').on('click', async function (e) {
        e.preventDefault(); // Evita o comportamento padrão do link

        console.log("Botão de logout clicado!");

        try {
          const token = localStorage.getItem('authToken'); // Recupera o token do localStorage
          if (!token) throw new Error("Token não encontrado!");

          // Chamada para a API de logout
          await apiRequest('http://localhost:3000/api/auth/logout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`, // Inclui o token no cabeçalho
            },
          });

          // Remove o token e redireciona
          localStorage.removeItem('authToken');
          sessionStorage.removeItem('authToken');
          document.cookie = "authToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          window.location.href = '/login';
        } catch (error) {
          console.error("Erro durante o logout:", error.message);
          alert("Erro ao realizar logout. Verifique sua conexão.");
        }
      });

      document.getElementById('add-field-btn').addEventListener('click', function () {
        // Seleciona o container dos campos dinâmicos
        const dynamicFields = document.getElementById('dynamic-fields');

        // Cria um novo conjunto de campos (para tipo, código e descrição)
        const newField = document.createElement('div');
        newField.classList.add('form-group', 'row');
        newField.innerHTML = `
          <label class="col-sm-3 col-md-3 col-form-label label-align">Tipo</label>
          <div class="col-sm-3">
            <input type="text" class="form-control" placeholder="Ex.: água, energia, tel, etc"
              data-parsley-required-message="O campo Tipo é obrigatório."
              data-parsley-trigger="change">
          </div>
          <div class="col-sm-2">
            <input type="text" class="form-control" placeholder="Ex.: 123456789123"
              data-parsley-required-message="O campo Código é obrigatório."
              data-parsley-trigger="change">
          </div>
          <div class="col-sm-3">
            <input type="text" class="form-control" placeholder="Descrição da conta"
              data-parsley-required-message="O campo Descrição é obrigatório."
              data-parsley-trigger="change">
          </div>
          <!-- Botão de excluir para o novo conjunto de campos, alinhado à direita -->
          <div class="col-sm-1 text-right"><button type="button" class="btn btn-danger remove-field-btn">
              <i class="fa fa-trash"></i> 
            </button>
          </div>
        `;

        // Adiciona o novo conjunto de campos ao container
        dynamicFields.appendChild(newField);

        // Adiciona o evento de exclusão para o botão de excluir do novo campo
        newField.querySelector('.remove-field-btn').addEventListener('click', function () {
          dynamicFields.removeChild(newField); // Remove o campo
        });
      });

      // Adiciona evento de exclusão para o primeiro conjunto de campos
      document.querySelectorAll('.remove-field-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const field = btn.closest('.form-group'); // Encontra o campo mais próximo
          field.remove(); // Remove o campo
        });
      });


    });

    // Função genérica para chamadas à API
    async function apiRequest(url, options = {}) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
        }
        return response.status !== 204 ? response.json() : null;
      } catch (error) {
        console.error("Erro ao fazer requisição:", error.message);
        throw error;
      }
    };

    const map = L.map('map').setView([-24.4878, -47.835], 7);

    // Adiciona camada do mapa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // Marker inicial
    let marker = L.marker([-24.4878, -47.835], { draggable: true }).addTo(map);

    // Atualiza inputs quando o marcador é movido
    marker.on('move', async function (e) {
      const { lat, lng } = e.latlng;
      document.getElementById('latitude').value = lat.toFixed(6);
      document.getElementById('longitude').value = lng.toFixed(6);

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        if (data.address) {
          document.getElementById('logradouro').value = data.address.road || '';
          document.getElementById('numero').value = data.address.house_number || '';
          document.getElementById('bairro').value = data.address.neighbourhood || data.address.suburb || '';
          document.getElementById('cidade').value = data.address.city || data.address.town || data.address.village || '';
          document.getElementById('estado').value = data.address.state || '';
          document.getElementById('cep').value = data.address.postcode || '';
        }
      } catch (error) {
        console.error("Erro ao obter endereço reverso:", error);
      }
    });

    // Botão Address → Position
    document.getElementById('addressPosition').addEventListener('click', async () => {
      const address = prompt("Digite o endereço:");
      if (address) {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${address}`);
          const data = await response.json();
          if (data.length > 0) {
            const { lat, lon } = data[0];
            const newLatLng = new L.LatLng(lat, lon);
            marker.setLatLng(newLatLng);
            map.setView(newLatLng, 14);
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
          } else {
            alert("Endereço não encontrado!");
          }
        } catch (error) {
          alert("Erro ao buscar endereço!");
        }
      }
    });

    // Botão Set Position
    document.getElementById('setPosition').addEventListener('click', () => {
      const lat = parseFloat(document.getElementById('latitude').value);
      const lng = parseFloat(document.getElementById('longitude').value);
      if (!isNaN(lat) && !isNaN(lng)) {
        const newLatLng = new L.LatLng(lat, lng);
        marker.setLatLng(newLatLng);
        map.setView(newLatLng, 14);
      } else {
        alert("Insira valores válidos de Latitude e Longitude!");
      }
    });

    // Botão Get GPS Position
    document.getElementById('getGPSPosition').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const { latitude, longitude } = position.coords;
          const newLatLng = new L.LatLng(latitude, longitude);
          marker.setLatLng(newLatLng);
          map.setView(newLatLng, 14);
          document.getElementById('latitude').value = latitude.toFixed(6);
          document.getElementById('longitude').value = longitude.toFixed(6);
        }, () => {
          alert("Não foi possível obter a localização!");
        });
      } else {
        alert("Geolocalização não suportada pelo navegador!");
      }
    });

    function submitForm() {
      const token = localStorage.getItem('authToken'); // Substitua pelo método apropriado

      // Extrair os horários da tabela
      const horarios = [];
      $('#tabela_horarios tbody tr').each(function () {
        const dia = $(this).find('td').eq(0).text();
        const horaAbertura = $(this).find('td').eq(1).text();
        const horaFechamento = $(this).find('td').eq(2).text();
        if (dia && horaAbertura && horaFechamento) {
          horarios.push({
            dia_semana: dia,
            hora_abertura: horaAbertura,
            hora_fechamento: horaFechamento,
          });
        }
      });

      // Construir o objeto churchData
      const churchData = {
        churches: [
          {
            nome: $('#nome').val(),
            categoria: $('#categoria').val(),
            endereco: {
              logradouro: $('#logradouro').val(),
              numero: $('#numero').val(),
              bairro: $('#bairro').val(),
              cidade: $('#cidade').val(),
              estado: $('#estado').val(),
              pais: "Brasil",
              cep: $('#cep').val(),
              complemento: $('#complemento').val(),
            },
            localizacao: {
              latitude: parseFloat($('#latitude').val()) || 0,
              longitude: parseFloat($('#longitude').val()) || 0,
              altitude: 0,
            },
            detalhes: {
              tipo_local: $('#tipo_local').val(),
              descricao: $('#descricao').val(),
              ponto_referencia: $('#ponto_referencia').val(),
              estacionamento: $('#estacionamento').val(),
              status: $('#status').val(),
              horario_funcionamento: horarios, // Adicionando os horários
            },
            contato: {
              telefone: $('#telefone').val(),
              email: $('#email').val(),
              alkipage: $('#alkipage').val(),
              instagram: $('#instagran').val(),
              facebook: $('#facebook').val(),
            },
            avaliacao: {
              nota_media: 0,
              numero_avaliacoes: 0,
            },
          },
        ],
      };

      createChurch(churchData); // Chama a função de criação da igreja
    }

    async function createChurch(churchData) {
      try {
        const url = 'http://localhost:3000/api/churches';
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(churchData),
        };

        const response = await apiRequest(url, options); // Usando apiRequest

        const newToken = response.headers.get('Authorization'); // Captura o novo token
        if (newToken) {
          localStorage.setItem('authToken', newToken.split(' ')[1]); // Atualiza o token local
        }

        if (response) { // apiRequest já trata 403, então só valida o retorno aqui
          alert("Igreja criada com sucesso!");
          console.log("Resposta da API:", response);
        }
      } catch (error) {
        console.error("Erro ao enviar a requisição:", error);
        alert("Ocorreu um erro ao tentar criar a igreja!");
      }
    }

    async function apiRequest(url, options = {}) {
      const token = localStorage.getItem('authToken');

      // Adicione o token ao cabeçalho da requisição
      if (token) {
        options.headers = {
          ...options.headers,
          'Authorization': `Bearer ${token}`,
        };
      }

      try {
        const response = await fetch(url, options);

        // Se o token estiver expirado ou inválido (403), redirecione
        if (response.status === 403) {
          const errorData = await response.json();
          console.error('Erro de autenticação:', errorData.message);
          alert('Sua sessão expirou. Faça login novamente.');
          localStorage.removeItem('authToken'); // Remova o token antigo
          window.location.href = '/login'; // Redirecione para login
          return;
        }

        if (!response.ok) {
          throw new Error(`Erro: ${response.status} - ${response.statusText}`);
        }

        return response.json();
      } catch (error) {
        console.error('Erro ao fazer a requisição:', error);
        throw error; // Opcional: propagar o erro para lidar em outro lugar
      }
    }

    document.querySelector('.dropdown-item.logout').addEventListener('click', async function () {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) throw new Error("Token não encontrado!");

        // Logout na API
        await apiRequest('http://localhost:3000/api/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`, // Inclui o token no cabeçalho
          },
        });

        // Remover token e redirecionar
        localStorage.removeItem('authToken');
        sessionStorage.removeItem('authToken');
        document.cookie = "authToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = '/login';
      } catch (error) {
        console.error("Erro durante o logout:", error.message);
        alert("Erro ao realizar logout. Verifique sua conexão.");
      }
    });

    async function apiRequest(url, options = {}) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
        }
        return response.status !== 204 ? response.json() : null; // 204 = sem conteúdo
      } catch (error) {
        console.error("Erro ao fazer requisição:", error.message);
        throw error;
      }
    }


  </script>
</body>

</html>